### 테크 동영상 링크
https://www.youtube.com/watch?v=D_QH50UkX_4

## 적정 소프트웨어 아키텍처
##### 향로가 생각하는 적정이란  단어의 정의?
A라는 목표를 B라는 일정 안에 달성하기 위해 감수하는 제약 조건

### 시즌 1
- 돈과 개발자 동료들 모두 없었다! ( 개발자가 대표 한명! )
	-> 직접 개발 최소화 , 외부 자원 최대한 활용 ( SaSS )
=> Wordpress +MySQL을 사용했다!
- 수정이 필요하면 , 직접 수정해나감

#### 문제점?
회원수가 10만이 되어가며 드러나기 시작!
- 매우 느려지는 서비스 ( Wordpress 는 보편적인 Service - 최적화 X )
- 의도를 알 수 없는 데이터 ( 워드프레스가 저장하는 데이터가 의도한 테이블이 아니므로 )
- 워드프레스로 인한 기능 확장 한계 ( 다른 기능 제공 위해선 , 굉장한 수정 필요! )
- 직접 관리 하는 서버 , 배포 , 데이터베이스 ( 일일이 다 해야함 )

=> 기능은 그대로 둔채 , 서비스를 직접 다시 만들자!

### 시즌 2
- 동료들이 추가가 됐다!
- BE 1 , FE 1 , DevOps 1 , 대표 1
-> 한명이 빠져도 개발이 가능하게 해야 한다!

#### 기술 스택 통일
- FE , BE , DevOps 전부 한 언어로!
-> Full JS Stack ( FE , BE , DevOps + Lambda 모두 JS 로 가능! )
		+ CDK 도 JS 로 관리
#### 낮은 러닝 커브
- 배울게 적고 , 가장 익숙한 방법
- 개발자 세분이 FP 에 익숙했음!
- 순수 함수 , JS 로 모든걸 관리
- 특정 프레임워크에 집중 보단 라이브러리 공통화를 하자! ( FX Series )
#### 최소 관리
- Circle CI , AWS 사용
- 직접적으로 서버를 관리하지 않기 위해

#### 아키텍처
![500](https://i.imgur.com/uAbyZwD.png)
##### In Node
![500](https://i.imgur.com/zdMGfEA.png)

- 현재로선 , 매우 원시적인 코드
- EJS , Jade 와 유사

- 구현 코드 최소화
- 단일화된 라이브러리
- 익숙한 패턴 ( 정적 HTML + jQuery )
- 단일 프로젝트 ( BE + FE )

=> 5개월 만에 전체 시스템 전환 완료 ( WordPress -> Full JS Stack )

#### 문제점

##### 신규 개발자들이 채용 되며 점점 발생하는 문제들
1. 구현 코드 최소화
	-> No Type , Only Object Literal , No Test Code
	- No Type : 함수만 보고 , 결과값 유추 불가능
	- Only Object Literal : JSON 단위 움직임 , SQL & API 결과물 코드상 확인 불가능
	- No Test Code : 짧은 개발 기간으로 , 테스트 코드 작성 불가능
2. 단일화 라이브러리
	-> 부족한 생태계 , 커뮤니티 , 문서
		![400](https://i.imgur.com/y8aK9qy.png)
		( 진짜 처음 봄 )
	Form , Validation , Video 등 대부분 Library 가 React 기반으로 변화중! ( 몇년전 라이브러리 사용해야함 )
3. 익숙한 패턴
	-> 신입 개발자는 익숙치 않은 구조 , 패턴 
	- 더이상 익숙하지 않게 되어버림 ( Front 대세는 React , Not JQuery! )
##### Dom 의 한계점 
![500](https://i.imgur.com/WzYI8nj.png)
- DOM , Event , Function 을 한 곳에 Component 로 관리 불가능!
##### 단일 프로젝트
- 비효율적인 Reload , Bundling 
- Local 첫 실행이 2분 , Reload 가 20초나 발생하는 문제점 발생!

### 시즌 3
- 기존 문제점들을 개혁하자!
- BE 3 , FE 3 , DevOps 1 , (Java/Spring 하던) CTO 1

#### 심리적 안정감
- 코드 수정 대한 자신감 , 코드 레벨에서 예측 가능한 결과물
- Class & Type 사용
- Test Code & Static Analysis
- eslint & prettier

#### 낮은 진입 장벽
- 외부 개발자가 많이 사용하는 라이브러리 / 구조 / 패턴
- Typescript
- React & Next.js <-> Nest.js & TypeOrm
- 계층형 Architecture & DI
- Terraform & Go
#### 독립성
- FE , BE 가 독립적 개발 가능
- API 명세 기반 개발
- 분리된 저장소

### 빅뱅 VS 점진적 개편
#### 빅뱅
- 서비스 개선 멈추고 , 전체 다시 만들어 한번에 교체
- 예상일정 약 1년
#### 점진적 개편
- 서비스 개선 과 시스템 개편 병행
- 기능 그룹별 이관
- 예상일정 약 2년

=> 점진적 개편 선택!
( 스타트업의 6개월이란 일반 기업의 2년 간 )
( 매년 2~300% 성장 서비스를 중단 없이 개편하는 경험을 주고 싶었음! )

### 아키텍처
![500](https://i.imgur.com/rdxkn6T.png)

##### 프론트 엔드
- 신규 FE 모노레포로 하나씩 이관
1. (구) 인프런에 해당 페이지 요청
2. 비어있는 index.html 하달
3. 해당 index.html 에 react 로 화면 render
=> 
- Mono Repo
- Full Type ( any 금지 )
- 부분 Test Code
- React & React Query & React Hook Form
- FP

##### 백엔드
- Repo 를 두개 생성
- (신) 인프런 백엔드에서 기존 백엔드 로직 대부분 담당
- 통합 계정 에서 회원 인증만 관리 ( 각각의 서비스가 아닌 독립시키고 싶어서 )
- (구) 인프런은 API Gateway 역활!
	( API 권한 , 접근제어 )
	- 미전환 로직
	- Next.js 도입전까지 SSR 처리
=>
- 모노레포
- Full Type ( any 금지 )
- Full Test Code
- 계층형 아키텍처 & DI
- Class 기반 ORM
- OOP + FP

![400](https://i.imgur.com/wDX6Oaz.png)

# Everything Is Okay..?

![500](https://i.imgur.com/E0Mfhkt.png)
- 이벤트를 통한 , 엄청난 트래픽이 몰리면 발생하게 된 장애
=> 한 기능 장애가 전체 기능의 장애로 확장이 된다!

### 시즌 4

- 반 강제적 진행...!
-  BE 8 , FE 11 , DevOps 4 , (JS/TS/Java 아는) CTO 1

![500](https://i.imgur.com/GppAu9J.png)

- 아직 완벽하게 구 -> 신규 이전이 완벽하게 되지 못함!
##### 소소한 문제점
- 선착순 쿠폰 이벤트 했더니 전체 장애가 발생!
- 비즈니스 일괄 가입 하니 인프런이 다운!
- 어드민에서 엑셀 다운로드 하니 인프런이 503을 반환해요!

=> 장애를 격리하자!
( 한 기능 장애가 전체 장애로 퍼지지 않게 하기 위해서 )

 ![500](https://i.imgur.com/3eXnpRT.png)
- 독립적으로 운영 하는 서비스들 전부 분리
- Server Memory , CPU 많이 점유하는 고성능 요구 작업으로 인한 장애는 격리됨 ( 엑셀 , 대량 데이터 사용 )

##### DB 장애 격리는?
( DB 분리는 시즌5에 진행 - 아직 레거시도 안 끝났으니까.. )
- 분산 DB로 높아지는 복잡도
- 트랜잭션 관리 어려움
- 기존 쿼리들 전체 개편

=> 쌓여가는 비즈니스 요구사항에 따라 보류
- 검색엔진 좀 도입해줘요
- 데이터 Lake 구축해줘요
- 스냅샷 , 히스토리 기능 만들어줘요
- 전체 회원 알림 기록 필요해요...

#### 정답은 알고 있다
![500](https://i.imgur.com/M4TM94A.png)
- 가장 이상적인 답안
- 검색엔진은 ElasticSearch
- History , 알람같은 대량 데이터들은 NoSQL DynamoDB

=> 100만 회원 서비스에서 , 레거시를 개편하며 모든걸 안정적으로?
- 절대 불가능
	-> 기술 가지수를 최소화 , 최선 보다는 2~3년을 버틸 수 있는 적정 기술을 선택하자

#### 차선책 : MongoDB Atlas

- DynamoDB 와 같은 NoSQL
- ES 와 같은 Lucene 검색엔진
- ES Cloud 에서 지원하는 Nori 한글 형태소 분석기

=> 검색 엔진 , Data Lake , 실시간 데이터처리 등을 한번에 해결하자! ( 하나에만 집중을 하자 )

- 신규 구축 서비스들부터는 최소한 장애 격리된 형태로 가자

#### 번외 : 검색 엔진 아키텍처
![500](https://i.imgur.com/7IHqRvj.png)

- 이벤트 기반 아키텍처
- SNS 통한 멀티 구독 ( 블로그 글 변경 -> 상세 , 조회수 , 랭킹 , 검색 엔진 수많은 시스템이 이벤트 변화를 알아야 함 )
- SNS 를 통해 수많은 SQS 부착 가능 ( Message Queue , Lambda , Kinesis ) - 최종적 일관성 보장
- Spring Boot 에 있는 SQS Listener 통한 배압 조절 ( Back Pressue )
	-> 우리 서버가 허용하는 범위 내에서만 메시지를 빨아들여 검색 엔진과 DB 에 반영
- Zero Payload 통한 이벤트 순서 보장 ( id - 즉 key 값만 넣어서 이벤트 발행 ) 
##### Node -> SNS 로 이벤트 발행이 실패하면?
- 이벤트 저장소를 중간에 두면 해결...!
	-> 아키텍처 복잡도가 너무 높아져 , 포기.
	( 이번 시즌에서는 에러 로그 발생하면 수동 재발행 )

=> 검색엔진이라는 추가 의존성 하나 , 기존 서비스와 장애 격리된 구조 완성!



### 마무리

#### Everything Is Ok?
- 모든 Project가 끝난거 아닌가요? -> 끝났으면 뭐해요?
#### No!
- 아직 기존 프로젝트에서 10%로 정도밖에 이관하지 못함!
- 여전히 진행 단계! ( 3단계 , 4단계도 미완성 )

> 위대한 글쓰기는 존재하지 않는다.
> 오직 위대한 고쳐 쓰기만 존재할 뿐이다. - 엘윈 브록스 화이트 -

- 스타트업 아키텍처는 최고를 고르는 것이 아니다!
- 정답은 최고를 선택해야 하는 것이다.
=> 고객이 원하는 서비스를 원할 때 제공을 해줘야 한다!!
( 최고가 아닌 , 가장 적절한 아키텍처를 만들어서 제공하자 )


### 결론

- 인프런의 거대한 서비스는 갑자기 만들어진게 아니다!
- 간과하는 점이 완벽한 아키텍처와 완벽한 코드는 개발자를 위한것이며 ,
	고객들이 원하는 것이 아니다.
- 차선으로 타협안을 만들고 , 리팩토링을 해나가자!