---
tags:
  - 도커
강의명: "Docker & Kubernetes : 실전 가이드"
---
### 수동 배포의 문제점


- 컨테이너 충돌 & 다운 및 새로운 컨테이너로 교체
	=> 전체 컨테이너의 충돌 가능성 존재!
	=> 수동 모니터링을 요구 ( 수동으로 시작 )

- 트래픽 급증 시 , 더 많은 컨테이너 인스턴스 요구
	=> 다음 들어오는 요청 처리 전,  그전 요청 위해 멈춰 있을수 있으므로
	=> 컨테이너 수를 증가시켜 트래픽 부하도 감소 및 고르게 분산 기대

- 웹 개발만 위해 컨테이너가 사용되지 않음!
	=> 애플리케이션 실행 컨테이너 or 이미지 변환 테스크 등 다양하게 존재
	=> 서로 다른 파일에서 동일 태스크를 실행하는 여러 컨테이너 구동을 요구 

**∴** 워크로드 or 트래픽 증 / 감에 따라 실행 중 컨테이너 인스턴스 수 증/감 해야함 +
	트래픽이 균등하게 분산되어야 함

### 왜 Kubernetes ( k8s ) 인가?
#### ECS 가 주는 혜택
- 컨테이너 상태 자동 확인 + 자동 restart
- Auto scaling 지원 ( 컨테이너 인스턴스 수  동적 늘리거나 줄임 )
- Load balancer( 트래픽 균등 분할되는지 확인 ) 지원 +테스팅에 사용 가능한 , 동적 IP & 도메인 제공

#### ECS 가 주는 한계
- 결국 특정 Cloud Service 의 의존을 요구
- AWS 가 요구하는 대로 설정하고 작동시켜야 함
- 다른 클라우드 서비스로 교체시 , 해당 클라우드 조건 및 옵션을 학습해야함!

### 쿠버네티스란

-  오픈 소스 시스템이자 , 컨테이너를 오케스트레이션 하기 위한 도구
- 배포 방식 , 컨테이너 스케일링  , 실패 경우 모니터링 , 교체 방법 등 모든 것을 독립적 이며 쉽게 정의 가능

1. Automatic Deployment
2. Scaling & Load Balancing
3. Management

##### 오해
- cloud service provider 가 아니다! ( AWS or Azure 의 대안이 아님 ) - 오픈 소스 프로젝트
- cloud service provider 가 제공하는 service도 아님 ( AWS 가 서비스 위한 인스턴스만 제공 하는 느낌 )
- specific cloud service provider 에 의존 X ( 어떤 provider 에든 사용 가능 )
- 특정 machine 에서 돌리는 software 가 아님 ( 개념과 도구의 집합체 )
- 도커의 대안이 아님 ( 도커 컨테이너와 함께 작동해 어디에나 배포 가능 )
- 유료 서비스가 아님 ( 오픈 소스 프로젝트이기에 )

Kubernetes Configuration => ( Some Proider-specific Setup or Tool ) => Any Cloud Provider

- 일부 클라우드 프로바이더에 추가 구성이 필요한 경우? 
	=> 그 구성을 메인 파일에 추가하여 해결!
- 다른 클라우드 프로바이더와 함께 사용하려는 경우?
	=> 특화된 구성 제거 or 새로운 클라우드 프로바이더로 교체!

**∴** 결국 쿠버네티스는 배포를 설명하는 표준화된 방식

- 도커 컴포즈와 유사한 느낌을 가짐
	( 도커 컴포즈는 로컬 머신에서 , 다중 컨테이너 프로젝트를 쉽게 관리하는데 도움을 줌 )
	=> 다중 머신 설정에 대해서 동일한 작업을 수행함! 
	( 애플리케이션은 하나의 머신이 아니라 , 여러 컴퓨터 여러 머신에서 실행해 수행하기 때문 )
	
=> 쿠버네티스는 배포용 docker-compose 와 유사

## 쿠버네티스 배포 아키텍처
![](https://i.imgur.com/I00WyMb.png)

## Pod
- 쿠버네티스 세계의 가장 작은 단위
- 쿠버네티스 위한 구성 파일에서 정의
- = Container 이나 , 항상 함께 작동하는 여러 컨테이너도 보유 가능 ( 꼭 , Single Container 일 필요는 X 뜻 )
- 컨테이너를 실행할 책임 소유 + 워커 노드에서 자신을 실행함
- 마스터 노드가 사용 가능한 모든 워커 노드로 pod 자동 배포

## Worker Node

- 머신 , 가상 인스턴스의 느낌 ( EC2 Instance 가 워커 노드 )
- 동일한 워커 노드 중 하나에서 둘 이상 포드 실행 가능
=> 무조건 Cluster 내에서 워커 노드 하나 이상 반드시 필요! ( 포드 , 컨테이너 실행할 장소가 없기 때문 )
- 마스터 노드에서 관리  ( pod 도 역시 , 마스터 노드에 의해 관리 )
- 컨테이너에 속한 모든 리소스 ( 볼륨 등 ) 역시 호스팅  

### 구성 소프트에어
#### Docker : 워커 노드에서 컨테이너 생성 및 실행하기 위한 소프트웨어
#### kubelet
- 노드에 배포되는 Agent
- 마스터 노드의 API 서버와 통신하는 역활 ( 수행 명령 받아서 워커 노드에서 수행 + 워커 노드 상태 마스터로 전달 )
- 노드에 할당된 pod 들 생명주기 관리

=> 쿠버네티스로 원하는 최종 상태 정의 시 , AWS 가 쿠버네티스 정의에 맞게 서비스 제공해줌

#### kube-proxy
- 워커 노드에 할당된 pod 로 연결되는 네트워크 관리
	- 포드가 인터넷 연결할 수 있는지 검사
	- 포드 및 내부 컨테이너 가 외부 세계에서 어떻게 접근할 수 있는지 제어



## Master Node
- 워커 노드와 상호 작용해 제어하는 컨트롤 센터
- Controller Plane 을 가지고 있음.
=> 개발자가 직접 워커 노드 & 포드 관리 하는 것은 매우 비효율!
- 완전히 다른 서버 , 리모트 머신임! ( worker node 와 동일하다 생각 X )
	=> 이론적으로 마스터 노드이며 , 워커 노드 역활을 하는 하난의 머신 가질수는 있으나 매우 지양 
### 구성 소프트웨어
#### Controller Plane 
- Master node 에 의해 수행되어 , 워커 노드 & 포드를 관리
-  마스터 노드에서 실행되는 다양한 서비스의 다양한 도구 모음

#### API 서버
- 쿠버네티스 모든 기능들 REST API로 제공 해 , 명령 처리

#### Scheduler
- 포드 관찰
- 새 포드가 생성 되야 하는 워커 노드 선택 담당
( 포드가 비정상 or 다운 + 스케일링 인한 새 포드 추가해야 하는 경우에 )
- 워커 노드에 무엇을 해야하는지 API 서버에 알리는 역활

#### Kube-Controller-Manager
- 워커 노드 전체 감시 및 제어
- 적당한 수의 포드 가동 중에 있는지 확인
- Scheduler 와 API 서버와 긴밀하게 연동

#### Cloud-Controller-Manager
- Cloud Provider 에 따라 다름 
- Cloud Provider 에 무엇을 해야 하는지 알려줌 ( 명령 번역  )



## Cluster
- 위의 모든 것이 Cluster ( Master Node , Worker Node 들 )
-> 배포 or 원하는 최종 상태 구성하는 모든 것 의 Collection Set

마스터 노드가 Cloud Provider API 에 명령을 보냄 
-> Cloud Provider 의 특정 리소스 생성 및 최종 상태를 클라우드 프로바이더에 복제하도록 지시

( AWS 가 필요한 로드 밸런서 & 네트워크 + 쿠버네티스를 가지기 위해 필요한 EC2 인스턴스를 AWS 에서 생성하도록 상호작용 )
-> 마스터 노드인 EC2 인스턴스에서 쿠버네티스 와 쿠버네티스 툴을 실행후 , 이 네트워크에 속한 
다른 EC2 인스턴스를 제어해 포드에서 컨테이너 실행

### 쿠버네티스 실행 전 사전 환경
- 마스터 노드를 만들고 설정해야함
	-> 노드에 모든 쿠버네티스 소프트웨어 설치
	-> 필요한 모든 것을 구성해야 함
	-> 사용중인 클라우드 프로바이더 따라 , 쿠버네티스 클러스터에 필요한 부가 리소스 설정 해야할 수도 있음.
		( 로드 밸런서 , 특정 파일 시스템 서비스 등  )


## 용어
### Nodes
- 하나 or 여러 개의 포드 호스팅 하는 특정 하드웨어 용량 가지며
- 클러스터와 통신하거나 , 클러스터 내에서 통신하는 물리적 or 가상 머신
- 모든 워커 노드를 걸쳐 포드 관리하는 컨트롤 플레인을 가진 **마스터 노드**
- 포드를 호스팅 하는 실제 머신 ( 앱 컨테이너 + 컨테이너에 필요한 리소스 실행 ) 인 **워커 노드**

### Pods 
- 컨테이너 와 요구하는 리소스가 결합된 유닛
-  컨테이너르 시작해 특정 컨테이너 관리 ( 컨테이너 감싼 껍질 )
포드가 생성되는 것은 포드에서 컨테이너를 실행하는 것과 같은 의미 ( = docker run )

### Services
- 논리적 세트
- 결국 고유한 포드 및 컨테이너에 독립적 IP 주소를 가진 포드 그룹
- 포드에 접근하는데 중요하고 , 따라서 그 안에 있는 컨테이너도 중요
- 특정 IP 주소 or 도메인으로 특정 포드에 연결할 수 있도록 하는 용어