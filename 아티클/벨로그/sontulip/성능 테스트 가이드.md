## 아티클 링크

https://velog.io/@sontulip/performance-test

## 세줄 요약

## 내용

### 서론

#### 성능 테스트란?

"테스트" 는 특정 상황에서 발생하는 문제를 사전에 찾기 위한 작업
=> 단위 테스트는 특정 메소드 실행 상황에서 발생하는 문제 사전 찾기 위한 작업
=> 통합 테스트는 여러 메소드 와 외부 의존 모듈 함께할 때 발생 문제 사전 찾기 위한 작업

성능 테스트는 트래픽이 많은 상황에서 발생 문제 사전 찾기 위한 작업

##### 트래픽
- 1초 동안 서버로 요청되는 수
- RPS 로 표현 Request Per Second
- 단순 수치가 아닌 , 기존 내 서버에 최대 트래픽을 맞쳐 나가야함

##### 문제
서비스라는 건 결국 사용자를 만족시키기 위해 존재
	-> 불만족 시키는 모든 것이 "문제"
###### 트래픽이 많은 상황에서의 문제들은?
- 서비스 처리 속도가 느려짐
- 서버의 리소스 부족으로 더 이상 사용자 요청에 응답 불가
- 숨겨져 있던 버그로 인해 서버 오작동

### 테스트 계획 짜기

현재 , Web Server -> Web Applicatoin Server -> DB 이루어진 3tier 형태 구조의 서버

#### 테스트의 목표
![400*400](https://i.imgur.com/Bi1Qbkp.png)
- 해당 목표 시 , 경로 검색 결과 페이지는 45 + 27.8 + 65 로 약 138ms

#### 트래픽 알아내기
- 오픈된 서비스라면 , APM 툴 이용해 최대 트래픽 확인 가능
- 오픈하지 않은 서비스라면 , 주요 경쟁사를 통해 추측 가능

1일 총 요청수 = DAU ( Daily Active User ) * 1명당 1일 평균 요청 수
1일 평균 요청 수 = 1일 총 요청 수 / 하루 12시간 초로 환산 ( 43260 )
1일 최대 rps = 1일 평균 rps * 피크 시간 집중률
( 집중률은 평균 트래픽 보다 얼마나 집중될 지 예상 )

=> 1초에 X 번 요청 하는 상황에서 각 페이지를 기존 기대한 132ms , 138ms 안에 제대로 된 응답 주는지 테스트
=> 문제가 없다면 , 서버 최대 성능 알아보기 위한 최대 트래픽 넘어서는 부하 주어가며 문제 발생 지점 찾기

### 테스트 툴

JMeter , nGrinder , K6 등 다양한 도구들 존재
#### 테스트 도구 선택 기준
- 시나리오 기반 테스트 가능
- 동시 접속자 수 , 요청 간격 , 최대 RPS 등 부하 조정 해야함
- 부하 테스트 진행하는 Agent 서버의 Scale Out 을 지원하는 등 충분한 부하 줄 수 있어야 함

=> 아티클 작성자는 Grafana 와 연동이 가능한 K6 선택
##### Grafana?
데이터 수집해 이를 시각화 해주는 오픈 소스 분석 & 모니터링 플랫폼
웹 기반 인터페이스로 대시보드 생성 + 다양한 시각적 형태 표현 가능

### 테스트 환경
#### 테스트 스펙
- 실제 상황과 최대한 유사하게 진행

#### 시나리오에 따른 테스트 스크립트
1. 부하를 줄 가상 사용자 수 ( Vuser )
2. 부하 시간
#### Vuser

동시 사용자는 
사이트 띄워놓고 , 콘텐트를 보고 있는 Concurrent User
요청을 보내고 요청 처리 기다리고 있는 Active User

=> Vuser 는 지속해서 요청을 보내기 때문에 Active User 를 묘사한다고 생각
##### 계산 공식

Vuser = 목표 rps * ( 한번 시나리오 완료에 걸리는 시간 ) / 시나리오 당 요청수
= 목표 rps * ( 요청1 목표 시간 + think time 1 + 요청 2 목표 시간 + think time 2 + ..N) / N

think time 은 현실 상황을 반영하기 위한 행동 사이 사이 간 존재하는 대기 시간
-> 경로 검색 페이지 요청 하고 1초 동안 (**이것 저것 하다가 경로 검색 페이지 결과 요청**)

=> think time 이 길어질 수록 목표 rps 를 만들기 위해 필요한 Vuser 가 많아짐

- 최대한 현실적이고 , 그에 따라 늘리는 것이 좋음
- 하나의 K6 서버가 만들기에는 부하가 한계가 있음

∴ 925 x (경로 검색 목표 응답 시간 + think time + 경로 겸색 결과 목표 응답 시간 ) / 요청 수
= 925 x  (0.132 + 0 + 0.138) /2
= 125

#### 부하 시간

일반적인 성능 테스트 진행중에는 30분 ~ 2시간 사이로 진행
-> 굉장히 오랜 시간 테스트를 하는 것은 내구성 테스트

### 테스트 스크립트

스크립트는 두 가지로 구분
- options
- code

#### options
```javascript
export let options = {
  stages: [ // 테스트 단계, 아래에 설정된대로 테스트가 진행된다. 
    { duration: '3m', target: 25 }, //먼저 3분 동안 VUser 1에서 25까지 서서히 올린다.
    { duration: '10m',target: 25 }, //Vuser 25에서 10분간 유지한다.
    { duration: '3m', target: 125 }, //다시 3분간 25에서 125까지 서서히 올린다.
    { duration: '30m',target: 125 }, //30분간 유지
    { duration: '3m', target: 0 },  //3분 동안 Vuser 0으로 내려온다.
  ],

  thresholds: { // 부하 테스트가 언제 성공했다고 할 수 있는지
    http_req_duration: ['p(95)<138'], // 전체 요청의 95%가 138ms 안에 들어오면 성공
  },
};
```
- options 는 test를 어떻게 할 지 설정
- 코드 내에서 사용하는게 아닌 , k6 자체에서 import 해서 사용 하는 걸로 예정
- @types 로 객체 옵션 까진 제공 X
###### stages : 테스트 동안 사용자 수가 어떻게 변화할 지 정의
###### thresholds : 테스트 성공 기준 결정
#### code
```javascript
function getPath(){
  let pathRes = http.get(`${BASE_URL}/path`, {
    tags: {
      page_name: "get_path"
    },
  });

  check(pathRes, {
    'success to get path': (res) => res.status === 200
  });
}
export default function ()  {
  getPath();
};
```
- default function 구문 안에 그대로 넣어도 상관 없음
###### tags 를 통해 결과 볼 수 있게 지정
###### check 를 통해 , 결과의 성공 여부 지정

#### load vs stress

최대 트래픽에서 발생하는 문제 찾는 테스트 => load test
최대 트래픽 이상의 부하를 주어가며 시스템 한계에서 발생하는 문제 찾는 테스트 => stress test

----
![500*500](https://i.imgur.com/8KAdSdI.png)

하단 , 구체적인 실행 화면과 실행 내용은 생략

## 결론

역시 부하 테스트란 매우 어렵다.
일개 학생 개발자가 가볍게 건드릴 주제는 아닌 거 같다.
부하 테스트의 핵심은 무지막지하게 많이 하거나 , 길게 하는것이 아니다!
	-> 오히려 , 정말 실제 상황을 고려하여 테스트를 하여야만 함

## 참고 링크

https://k6.io/

##### Writed By Obisidan